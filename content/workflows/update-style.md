# Update Style Workflow

> AI 小说写作系统的文风增量更新工作流。本文档定义在已有文风指南基础上，通过分析新增样本来增量更新 `style-guide.md` 与 `excerpts/` 的完整流程。执行本工作流的 AI 应能独立完成全部步骤，无需额外上下文。

---

## Prerequisites

在开始本工作流之前，必须满足以下前置条件：

- **已有文风指南**：`styles/{style-name}/style-guide.md` 已存在且状态为 `locked`（由 `/new-style` 工作流生成）。
- **已有摘录目录**：`styles/{style-name}/excerpts/` 已存在且包含分类文件。
- **新增样本已就绪**：`raw-samples/` 目录中包含尚未被分析的新 `.txt` 文件。
- **语言配置已加载**：已加载目标语言的 profile（如 `profiles/zh-CN.md`）。

目录结构示例：

```
styles/{style-name}/
├── raw-samples/
│   ├── sample-01.txt          ← 已分析（已被 style-guide 引用）
│   ├── sample-02.txt          ← 已分析
│   ├── sample-03.txt          ← 已分析
│   ├── sample-04.txt          ← 新增（未被 style-guide 引用）
│   └── sample-05.txt          ← 新增
├── style-guide.md             ← 已锁定，待增量更新
├── style-rules.md
└── excerpts/
    ├── narration.md
    ├── dialogue.md
    └── ...
```

---

## Step-by-Step Process

### Step 1: Confirm Target Style and Detect New Samples / 确认目标文风与检测新样本

- [ ] 确认用户要更新的文风目录（`styles/{style-name}/`）
- [ ] 读取 `style-guide.md`，确认当前状态为 `locked`
- [ ] 扫描 `raw-samples/` 下所有 `.txt` 文件
- [ ] 与 `style-guide.md` 中「引用原文」部分的来源文件列表比对，识别**新增样本**（未被引用过的文件）
- [ ] 若用户手动指定了新样本文件名，以用户指定为准
- [ ] 向用户展示检测结果：已分析样本 N 篇，新增样本 M 篇
- [ ] 用户确认后，将 `style-guide.md` 解锁（移除 `status: locked` 标记）

**输出**：新增样本文件列表、解锁的 `style-guide.md`。

---

### Step 2: Load Existing Analysis / 加载已有分析

- [ ] 读取当前 `style-guide.md` 完整内容
- [ ] 读取 `excerpts/` 下所有分类文件
- [ ] 读取语言 profile 文件（如 `profiles/zh-CN.md`），确认维度清单（如 zh-CN 共 16 个维度）
- [ ] 为每个维度提取 `style-guide.md` 中对应的现有分析段落，备用

**输出**：16 个维度的现有分析（从 `style-guide.md` 中提取）、维度清单。

---

### Step 3: Per-Dimension Incremental Analysis / 逐维度增量分析

- [ ] 仅将**新增样本**的完整内容传入子代理（非全部 raw-samples）
- [ ] 为每个维度启动 **style-analyzer** 子代理（可并行），使用增量模式提示模板（见下方「Subagent: style-analyzer (incremental mode)」）
- [ ] 每个子代理接收：新样本内容 + 该维度的现有分析结论
- [ ] 子代理输出三类结果：
  - **新发现**：现有分析未涉及的新特征
  - **强化发现**：与现有分析一致的特征（提供新证据）
  - **冲突发现**：与现有分析矛盾的特征
- [ ] 收集所有维度的增量分析结果

**输出**：16 个维度的增量分析结果（含新发现/强化/冲突分类）。

---

### Step 4: Merge and Present Diff / 合并并展示差异

- [ ] 将增量分析与现有 `style-guide.md` 逐维度合并：
  - **新发现** → 追加到该维度的特征列表
  - **强化发现** → 补充新引用证据到现有特征
  - **冲突发现** → 标记为需用户决定，展示双方证据
- [ ] 向用户展示逐维度对比报告：

```
## 维度 X：{维度名称}

### 保持不变
- [现有特征 1]

### 新增
- [新特征]：说明。证据：[新引用]

### 强化（补充证据）
- [现有特征 2]：新增证据 → [新引用]

### 冲突（需决定）
- 现有：[现有结论]（证据：[旧引用]）
- 新样本：[新结论]（证据：[新引用]）
- 建议：[保留原有 / 采用新结论 / 合并]
```

- [ ] 收集用户对每个冲突的决定
- [ ] 根据用户决定生成最终合并版本

**输出**：合并后的 16 个维度分析。

---

### Step 5: Update Excerpts / 更新摘录

- [ ] 从**新增样本**中提取代表性段落
- [ ] 按类别追加到已有的 `excerpts/` 文件中（不删除已有摘录）：
  - `narration.md`、`dialogue.md`、`description.md`、`psychology.md`、`action.md`、`four-char.md`、`classical.md`
- [ ] 每个摘录标注来源文件与大致位置（如 `sample-04.txt, ~line 80`）
- [ ] 若某类别在新样本中无代表性段落，跳过该类别
- [ ] 向用户展示新增摘录，确认后写入

**输出**：更新后的 `excerpts/` 文件。

---

### Step 6: Validation Writing / 验证写作

- [ ] AI 根据更新后的 `style-guide.md` 撰写一段 300–500 字的测试段落
- [ ] 测试段落需覆盖：叙述、对白、描写、心理、动作等至少 3 类
- [ ] 用户将 AI 产出与**新旧样本**同时对比
- [ ] 记录差异点：语气、句式、用词、节奏等
- [ ] 若差异明显，回到 Step 4 进行针对性修正
- [ ] 若用户认可相似度，进入 Step 7

**输出**：验证段落文本及用户对比结论。

---

### Step 7: Reassemble and Re-lock / 重新组装并锁定

- [ ] 将合并后的 16 个维度分析重新组装为 `style-guide.md`
- [ ] 更新「摘录索引」，反映 `excerpts/` 的最新状态
- [ ] 在文件头部重新标记 `status: locked`
- [ ] 通知用户工作流已完成，展示变更摘要：
  - 新增样本数
  - 新增特征数
  - 修订特征数
  - 新增摘录数

**输出**：重新锁定的 `style-guide.md`、更新后的 `excerpts/`。

---

## Subagent: style-analyzer (incremental mode)

当存在子代理能力时，使用 **style-analyzer** 子代理执行增量分析。每个子代理调用使用以下模板：

### 输入

- **new_raw_content**：新增样本文件的拼接内容（仅新样本）。
- **dimension_id**：当前分析的维度编号（1–16）。
- **dimension_name**：维度名称（如「叙事视角」「文白比例」）。
- **existing_analysis**：该维度在现有 `style-guide.md` 中的分析结论。

### 提示模板（Prompt Template）

```
你是一个风格分析子代理（style-analyzer），运行在**增量模式**。你的任务是分析新增样本在**单一维度**上的表现，并与该维度的现有分析进行对比。

## 输入
- 维度编号：{dimension_id}
- 维度名称：{dimension_name}
- 现有分析结论：
---
{existing_analysis}
---
- 新增样本全文：
---
{new_raw_content}
---

## 要求
1. 仅分析上述**一个**维度，不要涉及其他维度。
2. 将新样本的分析结果与「现有分析结论」逐条对比。
3. 每个结论必须引用至少 **2 段**新样本原文作为证据，格式为：
   > 「引用原文」
   > — 来源：sample-XX.txt
4. 输出必须严格遵循下方「输出模板」的结构。
5. 若新样本中该维度证据不足，明确标注「证据不足」。

## 输出模板

### 维度：{dimension_name}（增量分析）

#### 新发现
现有分析未涉及的新特征：
- [新特征]：说明。证据：[引用 1][引用 2]
- …
（若无，标注「无新发现」）

#### 强化发现
与现有分析一致、可补充新证据的特征：
- [现有特征名]：新证据 → [引用 1][引用 2]
- …
（若无，标注「无强化发现」）

#### 冲突发现
与现有分析矛盾的特征：
- 现有结论：[原结论]
  新样本表现：[新结论]。证据：[引用 1][引用 2]
  建议处理方式：[保留原有 / 采用新结论 / 合并为更全面的结论]
- …
（若无，标注「无冲突」）

#### 引用原文
1. 「…」 — sample-XX.txt
2. 「…」 — sample-XX.txt
…
```

### 输出

- 结构化 Markdown 增量分析结果。
- 必须包含至少 2 条带来源的新样本原文引用。

### 并行化

- 可为每个维度启动独立子代理，共 16 个并行任务。
- 主流程等待全部完成后合并结果。

---

## Multi-Pass Quality Methodology

为确保增量分析稳定可靠，采用多轮验证（与 `workflows/preprocess-style.md` 相同逻辑）：

### 轮次

1. **第一轮**：对每个维度执行一次增量 style-analyzer 分析。
2. **第二轮**：对冲突发现或结论模糊的维度再执行 1–2 次分析。
3. **第三轮**：若同一维度的多轮结果仍存在矛盾，以多数一致结论为准。

### 一致性规则

- **保留**：多轮增量分析中重复出现的新发现。
- **丢弃**：仅出现一次且与其他轮次矛盾的新发现。
- **冲突处理**：多轮分析均报告的冲突为「高置信度冲突」，必须呈现给用户决定。
- **强制引用**：每个新发现/冲突必须对应至少 2 段新样本原文引用。

---

## Preferred Path (with Subagent)

当系统支持子代理时，采用以下路径：

1. **Step 1–2**：主流程确认目标、加载现有分析。
2. **Step 3**：主流程并行启动 16 个 style-analyzer 子代理（增量模式），每个分析一个维度。
3. **Step 3 质量**：对冲突维度执行 2–3 轮分析，合并一致结论。
4. **Step 4–7**：主流程顺序执行合并展示、摘录更新、验证写作、锁定。

**优势**：并行分析、增量对比、保留现有分析基础。

---

## Degraded Path (without Subagent)

当无子代理能力时，全部工作在主对话中完成：

1. **Step 1–2**：主流程确认目标、加载现有分析。
2. **Step 3**：主流程**顺序**分析每个维度，每次仅处理一个维度，使用增量模式提示逻辑。
3. **Step 3 质量**：对冲突维度可进行 2 轮分析（主对话中分两次调用），合并结论。
4. **Step 4–7**：与 Preferred Path 相同。

**注意**：主对话需显式管理「当前维度」状态，避免在一次回复中混合多个维度。

---

## Execution Checklist (Summary)

执行本工作流时，可按此清单自检：

- [ ] Prerequisites：`style-guide.md` 已存在且为 locked，新样本已放入 `raw-samples/`
- [ ] Step 1：新增样本已识别，`style-guide.md` 已解锁
- [ ] Step 2：现有分析已加载，维度清单已确认
- [ ] Step 3：16 个维度增量分析已完成
- [ ] Step 3 质量：冲突维度多轮分析已执行
- [ ] Step 4：合并对比报告已展示，用户已决定所有冲突
- [ ] Step 5：新增摘录已追加到 `excerpts/`
- [ ] Step 6：验证段落已撰写，用户对比已通过
- [ ] Step 7：`style-guide.md` 已重新组装并锁定

---

*文档版本：1.0 | 适用于 AI 小说写作系统文风增量更新*
