# Archive Decision Workflow

AI 小说写作系统的决策归档工作流。定义如何将讨论中的决策捕获并归档到项目记忆文件中。

**适用技能**：`archive-decision`  
**执行环境**：主对话（无需子代理）

---

## Trigger Conditions

满足以下任一条件时触发本工作流：

1. **用户显式指令**
   - 用户明确说「记下来」「归档」「确认这个设定」等
   - 或表达类似意图（如「写进设定」「保存到记忆」）

2. **意图路由检测**
   - 对话分析识别出已确认的决策
   - 用户对某设定/方向表示肯定（如「就这样」「定了」「没问题」）

3. **会话结束前检查**
   - 会话即将结束时
   - 或用户表示要离开/结束讨论时
   - 检测到存在尚未归档的决策

---

## Step-by-Step Process

### Step 1: Extract Decision Content

- [ ] **识别决策内容**：从对话中提取「已决定」的信息
- [ ] **结构化表述**：用清晰、结构化的文字重新组织
- [ ] **去歧义**：确保表述无二义性，可被后续引用

**输出**：一段可归档的决策文本

---

### Step 2: Route to Target File

根据决策类型，查表确定目标文件：

| 决策类型 | 目标文件 |
|---------|---------|
| 角色相关（外貌、性格、说话方式、能力、人际关系） | `characters.md` |
| 世界相关（地理、历史、规则、文化、地点） | `world.md` |
| 剧情相关（故事方向、章节计划、幕结构） | `outline.md` |
| 伏笔/悬念相关 | `threads.md` |
| 其他 | `decisions.md` |

- [ ] 判断决策所属类型
- [ ] 确定目标文件
- [ ] 若跨多个类型，进入 Edge Case 处理（见下文）

---

### Step 3: Format the Entry

- [ ] **读取目标文件**：查看现有格式与模板
- [ ] **匹配格式**：按目标文件规范格式化条目

**各文件格式要求**：

| 目标文件 | 格式要求 |
|---------|---------|
| `characters.md` | 遵循角色条目模板（姓名、简介、外貌、性格、关系等） |
| `world.md` | 放入对应章节（地理/历史/规则/文化/地点） |
| `outline.md` | 更新对应层级（stable / rolling / log） |
| `threads.md` | 在「未解决」下添加为 `[ ]` 条目 |
| `decisions.md` | 使用带时间戳的条目格式 |

- [ ] 生成格式化后的完整条目
- [ ] 准备好向用户展示

---

### Step 4: User Confirms

- [ ] **展示建议**：向用户呈现以下内容

```
建议将以下内容归档到 `{target-file}`：

{formatted content}

确认写入？
```

- [ ] **等待用户确认**
- [ ] 若用户要求修改：调整内容后重新展示，再次确认
- [ ] 若用户拒绝：不写入，结束流程
- [ ] 若用户确认：进入 Step 5

---

### Step 5: Write with Timestamp

- [ ] **执行写入**：追加或更新目标文件
- [ ] **添加时间戳**：在条目中包含 `[YYYY-MM-DD]`
- [ ] **确认写入成功**：简要告知用户已完成归档

---

## End-of-Session Review Protocol

在会话结束前（或用户表示要离开时）执行：

1. **扫描对话**：回顾本次会话，找出所有已确认但未归档的决策
2. **汇总展示**：

```
本次讨论中以下内容尚未归档：

1. {决策摘要 1}
2. {决策摘要 2}
...

是否需要归档？
```

3. **逐项处理**：对用户确认要归档的每项，按 Step 1–5 执行
4. **用户拒绝的项**：不强制归档，可记录为「待定」供下次会话参考

---

## Edge Cases

### 决策修改已有条目

- **处理**：在原位置更新，并在变更日志中记录
- **流程**：展示「将更新 `{target-file}` 中的以下条目」，待用户确认后执行更新

### 决策与已有条目冲突

- **处理**：向用户发出警告
- **提示**：「该决策与现有设定存在冲突：{冲突描述}。请选择：A) 保留现有 / B) 以新决策为准 / C) 暂不归档」
- **流程**：根据用户选择执行

### 决策涉及多个文件

- **处理**：拆分为多条独立写入
- **流程**：每条分别格式化、分别展示、分别确认
- **原则**：每个文件的写入都需单独获得用户确认

---

## Core Principle

**AI 不得在未经用户确认的情况下写入记忆文件。**

此原则不可妥协。任何归档操作必须在 Step 4 获得用户明确确认后执行。

---

## Quick Reference

| 步骤 | 关键动作 |
|-----|---------|
| 1 | 提取并结构化决策内容 |
| 2 | 查表确定目标文件 |
| 3 | 按目标文件格式生成条目 |
| 4 | 展示并等待用户确认 |
| 5 | 确认后写入并加时间戳 |
